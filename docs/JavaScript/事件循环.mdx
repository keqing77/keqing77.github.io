---
sidebar_position: 11
---

# äº‹ä»¶å¾ªç¯

:::warning è¿™é‡Œçš„äº‹ä»¶å¾ªç¯æ˜¯åœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹çš„ï¼Œå¹¶énodeç¯å¢ƒä¸‹ï¼Œnodeäº‹ä»¶å¾ªç¯å•ç‹¬æ”¾åœ¨nodeç¯‡
`äº‹ä»¶å¾ªç¯æ˜¯é€šè¿‡ä»»åŠ¡é˜Ÿåˆ—çš„æœºåˆ¶æ¥è¿›è¡Œåè°ƒçš„ã€‚ä¸€ä¸ª Event Loop ä¸­ï¼Œå¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—(task queue)ï¼Œä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¾¿æ˜¯ä¸€ç³»åˆ—æœ‰åºä»»åŠ¡(task)çš„é›†åˆï¼›æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªä»»åŠ¡æº(task source)ï¼Œæºè‡ªåŒä¸€ä¸ªä»»åŠ¡æºçš„ task å¿…é¡»æ”¾åˆ°åŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä»ä¸åŒæºæ¥çš„åˆ™è¢«æ·»åŠ åˆ°ä¸åŒé˜Ÿåˆ—ã€‚setTimeout/Promise ç­‰APIä¾¿æ˜¯ä»»åŠ¡æºï¼Œè€Œè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—çš„æ˜¯ä»–ä»¬æŒ‡å®šçš„å…·ä½“æ‰§è¡Œä»»åŠ¡ã€‚`
1. åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¯è¿›è¡Œä¸€æ¬¡å¾ªç¯æ“ä½œç§°ä¸º tickï¼Œæ¯ä¸€æ¬¡ tick çš„ä»»åŠ¡å¤„ç†æ¨¡å‹æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä½†å…³é”®æ­¥éª¤å¦‚ä¸‹ï¼š
1. åœ¨æ­¤æ¬¡ tick ä¸­é€‰æ‹©æœ€å…ˆè¿›å…¥é˜Ÿåˆ—çš„ä»»åŠ¡(oldest task)ï¼Œå¦‚æœæœ‰åˆ™æ‰§è¡Œ(ä¸€æ¬¡)
1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ Microtasksï¼Œå¦‚æœå­˜åœ¨åˆ™ä¸åœåœ°æ‰§è¡Œï¼Œç›´è‡³æ¸…ç©º Microtasks Queue
1. æ›´æ–° render
1. ä¸»çº¿ç¨‹é‡å¤æ‰§è¡Œä¸Šè¿°æ­¥éª¤
:::


## çº¿ç¨‹å’Œè¿›ç¨‹
`JavaScriptä¸€é—¨å•çº¿ç¨‹è¯­è¨€`ï¼Œä»€ä¹ˆæ˜¯å•çº¿ç¨‹ï¼Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªæ—¶é—´åªèƒ½åšä¸€ä»¶äº‹ã€‚äººç±»å°±æ˜¯å¤šçº¿ç¨‹ï¼Œæ¯”å¦‚ä¸€è¾¹æ€è€ƒğŸ¤”ä¸€è¾¹æ‹‰å±ğŸ’©ï¼Œèƒ½åŒæ—¶å¹²å¥½å‡ ä»¶äº‹ã€‚

:::info ä¸ºä»€ä¹ˆJSè¦è¢«è®¾è®¡æˆå•çº¿ç¨‹å‘¢ï¼Ÿ
ä½ è¯•æƒ³ï¼Œå¦‚æœä¸€ä¸ªDOMè¢«å‡ ä¸ªJSå‡½æ•°æ“ä½œè¯¥å¬è°çš„ï¼ŸåŠ ä¸Šçº¿ç¨‹é—´åˆ‡æ¢çš„å¼€é”€ï¼Œæ— ç–‘ä¼šè®©å¼€å‘è€…æ··ä¹±ã€‚
:::
### è¿›ç¨‹
`è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½`

è®¡ç®—æœºçš„æœ¯è¯­å°±æ˜¯æŠ½è±¡, ç®€å•æ¥ç†è§£æ¥è¯´å°±æ˜¯ ä¸€ä¸ªè¿›ç¨‹å°±æ˜¯ ä¸€ä¸ªç”Ÿäº§è½¦é—´(è¿›ç¨‹) , è½¦é—´é‡Œé¢å¯ä»¥æœ‰å¾ˆå¤šå·¥äºº(çº¿ç¨‹)

å°±æ‹¿æµè§ˆå™¨å†²æµªä¸¾ä¾‹å­ï¼Œä½ æ‰“å¼€ä¸€ä¸ªæ ‡ç­¾é¡µå®é™…ä¸Šå°±æ˜¯å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­åˆå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚JavaScriptå¼•æ“çº¿ç¨‹å’Œæ¸²æŸ“é¡µé¢çš„çº¿ç¨‹ã€‚è¿™ä¸¤ä¸ªçº¿ç¨‹æ˜¯äº’æ–¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“JavaScriptåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œæ¸²æŸ“è¿›ç¨‹æ˜¯è¢«é˜»å¡çš„ï¼Œåä¹‹åŒç†ã€‚
### çº¿ç¨‹
`çº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½`

> è¿›ç¨‹å’Œçº¿ç¨‹éƒ½æ˜¯ä¸€ä¸ªæ—¶é—´æ®µçš„æè¿°ï¼Œæ˜¯CPUå·¥ä½œæ—¶é—´æ®µçš„æè¿°ï¼Œä¸è¿‡æ˜¯é¢—ç²’å¤§å°ä¸åŒã€‚
- çº¿ç¨‹æ˜¯å…±äº«äº†è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œçš„æ›´ä¸ºç»†å°çš„CPUæ—¶é—´æ®µã€‚çº¿ç¨‹ä¸»è¦å…±äº«çš„æ˜¯è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚


![](https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop/the_javascript_runtime_environment_example.svg)

## æ‰§è¡Œæ ˆ

> æ‰§è¡Œæ ˆå°±æ˜¯ä¸€ä¸ªæ‰§è¡ŒJSäº‹ä»¶çš„æ ˆï¼Œéµå¾ªå…ˆè¿›åå‡ºçš„ç†å¿µã€‚

- JSå¼•æ“é‡åˆ°å¼‚æ­¥çš„ä»£ç æ—¶ï¼Œä¼šè¢«æŒ‚èµ·å¹¶åœ¨éœ€è¦æ‰§è¡Œçš„æ—¶å€™åŠ å…¥åˆ° Taskï¼ˆæœ‰å¤šç§ Taskï¼‰Queueé˜Ÿåˆ—ä¸­ã€‚
  - ä¸€æ—¦æ‰§è¡Œæ ˆä¸ºç©ºï¼ŒEvent Loop å°±ä¼šä» Task é˜Ÿåˆ—ä¸­æ‹¿å‡ºéœ€è¦æ‰§è¡Œçš„ä»£ç å¹¶æ”¾å…¥æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚
  - Taskåˆè¢«åˆ†ä¸ºå®ä»»åŠ¡(macrotask ç§°ä¸º task)å’Œå¾®ä»»åŠ¡(microtask ç§°ä¸º jobs)
- åŒä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ä¸­åŒæ­¥ä»»åŠ¡ä¼˜å…ˆäºå¼‚æ­¥ä»»åŠ¡
- ä¸åŒæ‰§è¡Œç¯å¢ƒä¸­çš„å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå…ˆåå–å†³äºå…¶åŠ å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—çš„æ—¶é—´å…ˆå

:::tip æ€»ç»“
äº‹ä»¶å¾ªç¯(Event Loop): æ‰§è¡Œå®ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œè¯¥å®ä»»åŠ¡äº§ç”Ÿçš„å¾®ä»»åŠ¡ï¼Œè‹¥å¾®ä»»åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æ–°çš„å¾®ä»»åŠ¡ï¼Œåˆ™ç»§ç»­æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œå¾®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†å›åˆ°å®ä»»åŠ¡ä¸­è¿›è¡Œä¸‹ä¸€è½®å¾ªç¯ã€‚
:::

## ä»»åŠ¡é˜Ÿåˆ—

### å®ä»»åŠ¡
- script(æ•´ä½“ä»£ç )
- setTimeout
- setInterval
- I/O
- UIäº¤äº’äº‹ä»¶
- postMessage
- MessageChannel
- setImmediate(Node.js ç¯å¢ƒ)

### å¾®ä»»åŠ¡

- Promise.then
- Object.observe
- MutationObserver
- process.nextTick(Node.js ç¯å¢ƒ)

## é¢˜ç›®

```js
console.log('script start')

async function async1() {
  await async2()
  console.log('async1 end')
}
async function async2() {
  console.log('async2 end')
}
async1()

setTimeout(function() {
  console.log('setTimeout')
}, 0)

new Promise(resolve => {
  console.log('Promise')
  resolve()
})
  .then(function() {
    console.log('promise1')
  })
  .then(function() {
    console.log('promise2')
  })

console.log('script end')
```

<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>
    <div>è¿™é‡Œéœ€è¦å…ˆç†è§£async/awaitã€‚
      async/await åœ¨åº•å±‚è½¬æ¢æˆäº† promise å’Œ then å›è°ƒå‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ˜¯ promise çš„è¯­æ³•ç³–ã€‚ æ¯æ¬¡æˆ‘ä»¬ä½¿ç”¨ await, è§£é‡Šå™¨éƒ½åˆ›å»ºä¸€ä¸ª promise å¯¹è±¡ï¼Œç„¶åæŠŠå‰©ä¸‹çš„ async å‡½æ•°ä¸­çš„æ“ä½œæ”¾åˆ° then å›è°ƒå‡½æ•°ä¸­ã€‚async/await çš„å®ç°ï¼Œç¦»ä¸å¼€ Promiseã€‚ä»å­—é¢æ„æ€æ¥ç†è§£ï¼Œasync æ˜¯â€œå¼‚æ­¥â€çš„ç®€å†™ï¼Œè€Œ await æ˜¯ async wait çš„ç®€å†™å¯ä»¥è®¤ä¸ºæ˜¯ç­‰å¾…å¼‚æ­¥æ–¹æ³•æ‰§è¡Œå®Œæˆã€‚
      awaitä¸‹é¢çš„ä»£ç  = promise.then() å¯ä»¥æŠŠ await çœ‹æˆæ˜¯è®©å‡ºçº¿ç¨‹çš„æ ‡å¿—</div>
    <br/>
  </div>
</details>

```js
async function async1() {
  console.log("async1 start");
  await async2();
  console.log("async1 end");
  setTimeout(() => {
    console.log('timer1')
  }, 0)
}
async function async2() {
  setTimeout(() => {
    console.log('timer2')
  }, 0)
  console.log("async2");
}
async1();
setTimeout(() => {
  console.log('timer3')
}, 0)
console.log("start")
```

<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>
    <pre>
      async1 start
      async2
      start
       async1 end
      undefined
      timer2
       timer3
      timer1
    </pre>
    <br/>
  </div>
</details>